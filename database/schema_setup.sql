-- ============================================================
-- CHARITY & ZAKAT DISTRIBUTION SYSTEM - ORACLE SCHEMA SETUP
-- ============================================================

-- 1. USER MANAGEMENT (Vertical Fragmentation)
-- ------------------------------------------------------------
-- Public User Info
CREATE TABLE USERS_PUBLIC (
    USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) UNIQUE NOT NULL,
    EMAIL VARCHAR2(100) UNIQUE NOT NULL,
    ROLE VARCHAR2(20) CHECK (ROLE IN ('DONOR', 'ADMIN', 'BENEFICIARY')),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Secure User Info (PII) - Vertically Fragmented
CREATE TABLE USERS_SECURE (
    USER_ID NUMBER PRIMARY KEY REFERENCES USERS_PUBLIC(USER_ID) ON DELETE CASCADE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL
);

-- View to join them (Transparent access)
CREATE OR REPLACE VIEW USERS AS
SELECT p.USER_ID, p.USERNAME, p.EMAIL, p.ROLE, p.CREATED_AT,
       s.PASSWORD_HASH
FROM USERS_PUBLIC p
JOIN USERS_SECURE s ON p.USER_ID = s.USER_ID;

-- 2. DONATIONS (Range Partitioning by Year)
-- ------------------------------------------------------------
CREATE TABLE DONATIONS (
    DONATION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    DONOR_ID NUMBER REFERENCES USERS_PUBLIC(USER_ID),
    AMOUNT NUMBER(12, 2) NOT NULL,
    CURRENCY VARCHAR2(3) DEFAULT 'PKR',
    DONATION_TYPE VARCHAR2(20) CHECK (DONATION_TYPE IN ('ZAKAT', 'SADAQAH', 'GENERAL')),
    DONATION_DATE DATE DEFAULT SYSDATE,
    STATUS VARCHAR2(20) DEFAULT 'PENDING' CHECK (STATUS IN ('PENDING', 'APPROVED', 'REJECTED')),
    CONSTRAINT pk_donations PRIMARY KEY (DONATION_ID, DONATION_DATE) -- Partition key must be part of PK
)
PARTITION BY RANGE (DONATION_DATE) (
    PARTITION p_2023 VALUES LESS THAN (TO_DATE('01-JAN-2024', 'DD-MON-YYYY')),
    PARTITION p_2024 VALUES LESS THAN (TO_DATE('01-JAN-2025', 'DD-MON-YYYY')),
    PARTITION p_2025 VALUES LESS THAN (TO_DATE('01-JAN-2026', 'DD-MON-YYYY')),
    PARTITION p_future VALUES LESS THAN (MAXVALUE)
);

-- 3. BENEFICIARIES (Horizontal Fragmentation Logic via Views)
-- ------------------------------------------------------------
CREATE TABLE BENEFICIARIES (
    BENEFICIARY_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER REFERENCES USERS_PUBLIC(USER_ID),
    REGION VARCHAR2(50) NOT NULL,
    INCOME_LEVEL NUMBER(10, 2),
    FAMILY_MEMBERS NUMBER,
    ELIGIBILITY_STATUS VARCHAR2(20) DEFAULT 'PENDING',
    DOCUMENTS BLOB, -- Storing file binary
    DOCUMENT_MIME_TYPE VARCHAR2(50),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 4. INDEXES
-- ------------------------------------------------------------
CREATE INDEX idx_donations_donor ON DONATIONS(DONOR_ID);
CREATE INDEX idx_beneficiaries_region ON BENEFICIARIES(REGION);
CREATE INDEX idx_users_email ON USERS_PUBLIC(EMAIL);

COMMIT;